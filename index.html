<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grocery List App</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">
  <style>
    /* Font Awesome 5.15.4 CSS (minified, embedded) */
    .fa,.fas,.far,.fal,.fad,.fab{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;display:inline-block;font-style:normal;font-variant:normal;text-rendering:auto;line-height:1}.fa-lg{font-size:1.33333em;line-height:.75em;vertical-align:-.0667em}.fa-xs{font-size:.75em}.fa-sm{font-size:.875em}.fa-1x{font-size:1em}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-6x{font-size:6em}.fa-7x{font-size:7em}.fa-8x{font-size:8em}.fa-9x{font-size:9em}.fa-10x{font-size:10em}.fa-fw{text-align:center;width:1.25em}.fa-ul{list-style-type:none;margin-left:2.5em;padding-left:0}.fa-ul>li{position:relative}.fa-li{left:-2em;position:absolute;text-align:center;width:2em;line-height:inherit}.fa-border{border:.08em solid #eee;border-radius:.1em;padding:.2em .25em .15em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left,.fas.fa-pull-left,.far.fa-pull-left,.fal.fa-pull-left,.fab.fa-pull-left{margin-right:.3em}.fa.fa-pull-right,.fas.fa-pull-right,.far.fa-pull-right,.fal.fa-pull-right,.fab.fa-pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.fa-rotate-90{-ms-filter:"progid:Microsoft.BasicImage(rotation=1)";-webkit-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{-ms-filter:"progid:Microsoft.BasicImage(rotation=2)";-webkit-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{-ms-filter:"progid:Microsoft.BasicImage(rotation=3)";-webkit-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{-ms-filter:"progid:Microsoft.BasicImage(rotation=0, mirror=1)";-webkit-transform:scale(-1, 1);transform:scale(-1, 1)}.fa-flip-vertical{-ms-filter:"progid:Microsoft.BasicImage(rotation=2, mirror=1)";-webkit-transform:scale(1, -1);transform:scale(1, -1)}.fa-flip-both,.fa-flip-horizontal.fa-flip-vertical{-ms-filter:"progid:Microsoft.BasicImage(rotation=2, mirror=1)";-webkit-transform:scale(-1, -1);transform:scale(-1, -1)}:root .fa-rotate-90,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-flip-horizontal,:root .fa-flip-vertical,:root .fa-flip-both{filter:none}.fa-stack{display:inline-block;height:2em;line-height:2em;position:relative;vertical-align:middle;width:2.5em}.fa-stack-1x,.fa-stack-2x{left:0;position:absolute;text-align:center;width:100%}.fa-stack-1x{line-height:inherit}.fa-stack-2x{font-size:2em}.fa-inverse{color:#fff}.sr-only{border:0;clip:rect(0, 0, 0, 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.sr-only-focusable:active,.sr-only-focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}.fa-shopping-cart:before{content:"\f07a"}.fa-filter:before{content:"\f0b0"}@font-face{font-family:'Font Awesome 5 Free';font-style:normal;font-weight:400;font-display:block;src:url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-regular-400.eot");src:url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-regular-400.eot?#iefix") format("embedded-opentype"),url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-regular-400.woff2") format("woff2"),url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-regular-400.woff") format("woff"),url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-regular-400.ttf") format("truetype"),url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-regular-400.svg#fontawesome") format("svg")}.far{font-family:'Font Awesome 5 Free';font-weight:400}@font-face{font-family:'Font Awesome 5 Free';font-style:normal;font-weight:900;font-display:block;src:url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-solid-900.eot");src:url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-solid-900.eot?#iefix") format("embedded-opentype"),url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-solid-900.woff2") format("woff2"),url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-solid-900.woff") format("woff"),url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-solid-900.ttf") format("truetype"),url("https://use.fontawesome.com/releases/v5.15.4/webfonts/fa-solid-900.svg#fontawesome") format("svg")}.fas{font-family:'Font Awesome 5 Free';font-weight:900}

    /* App CSS */
    body {
      font-family: Arial, sans-serif;
      font-size: 16px;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background-color: #f5f5f5;
    }
    .container {
      width: 100%;
      max-width: 600px;
      margin: 10px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
      font-size: 32px;
    }
    h2 {
      font-size: 24px;
    }
    .controls {
      margin-bottom: 20px;
      font-size: 16px;
    }
    .control-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 5px;
      margin-bottom: 5px;
    }
    select, input {
      padding: 8px;
      margin: 2px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      padding: 8px;
      margin: 2px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      box-sizing: border-box;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      width: 120px;
      white-space: normal;
      word-wrap: break-word;
    }
    button:hover {
      background-color: #0056b3;
    }
    .cancel-btn {
      background-color: #6c757d;
    }
    .cancel-btn:hover {
      background-color: #5a6268;
    }
    .edit-btn {
      background-color: #007bff;
    }
    .edit-btn:hover {
      background-color: #0056b3;
    }
    .delete-btn {
      background-color: #dc3545;
    }
    .delete-btn:hover {
      background-color: #c82333;
    }
    .undo-btn {
      background-color: #ffc107;
      color: #000;
    }
    .undo-btn:hover {
      background-color: #e0a800;
    }
    .update-btn {
      background-color: #17a2b8;
    }
    .update-btn:hover {
      background-color: #138496;
    }
    .table-container {
      max-height: calc(100vh - 250px);
      overflow-y: auto;
      position: relative;
    }
    .item-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      table-layout: fixed;
      font-size: 14px;
    }
    .item-table thead th {
      position: sticky;
      top: 0;
      background-color: #f0f0f0;
      z-index: 1;
      font-size: 14px;
      cursor: pointer;
    }
    .item-table th:hover {
      background-color: #e0e0e0;
    }
    .item-table th,
    .item-table td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
      box-sizing: border-box;
    }
    .item-table th:nth-child(1), .item-table td:nth-child(1) { width: 25% !important; } /* Name */
    .item-table th:nth-child(2), .item-table td:nth-child(2) { width: 10% !important; } /* Qty */
    .item-table th:nth-child(3), .item-table td:nth-child(3) { width: 13% !important; } /* Unit */
    .item-table th:nth-child(4), .item-table td:nth-child(4) { width: 20% !important; } /* Category */
    .item-table th:nth-child(5), .item-table td:nth-child(5) { width: 10% !important; text-align: center; } /* Procured */
    .item-table th:nth-child(6), .item-table td:nth-child(6) { width: 22% !important; white-space: normal; word-wrap: break-word; } /* Remarks */
    .item-table tr {
      cursor: pointer;
    }
    .modal-active .item-table,
    .modal-active .item-table thead th {
      opacity: 0.5;
    }
    .progress {
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
      font-size: 16px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      width: 90%;
      max-width: 400px;
      font-size: 16px;
    }
    .modal-content label {
      font-size: 16px;
    }
    .close-btn {
      position: absolute;
      right: 10px;
      top: 10px;
      cursor: pointer;
      font-size: 18px;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin-top: 10px;
      font-size: 16px;
    }
    .modal-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    .modal-actions button {
      flex: 1;
      margin: 0 2px;
      padding: 8px;
      font-size: 14px;
    }
    #undoNotification {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 16px;
    }
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      .modal-actions button {
        padding: 6px;
      }
      #undoNotification {
        width: 90%;
        padding: 8px 16px;
      }
      .control-row {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 1%;
      }
      .control-row button {
        width: 48%;
        max-width: 45%;
        margin: 0.5%;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Grocery List App</h1>
    <div class="controls">
      <div class="control-row">
        <button onclick="createNewList()">New List</button>
        <button onclick="openModal('load')">Load List</button>
        <button onclick="openModal('save')">Save List</button>
        <button onclick="openModal('share')">Share List</button>
      </div>
      <div class="control-row">
        <button onclick="openModal('item')">Add Item</button>
        <button onclick="openModal('category')">Edit Category</button>
        <button onclick="openModal('shop')">Set Shop</button>
        <button onclick="clearAllProcured()">Reset</button>
      </div>
    </div>
    <div class="progress" id="progress">0 of 0 items procured - 0%</div>
    <div id="listDate"></div>
    <div class="table-container">
      <table class="item-table">
        <thead>
          <tr>
            <th onclick="sortByColumn('name')">Name <span id="sortNameIndicator"></span></th>
            <th>Qty</th>
            <th>Unit</th>
            <th onclick="sortByColumn('category')">Category <span id="sortCategoryIndicator"></span></th>
            <th onclick="toggleFilter()" aria-label="Procured Status"><span id="filterIndicator"><i class="fas fa-shopping-cart"></i></span></th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody id="itemList"></tbody>
      </table>
    </div>
    <div id="undoNotification">
      Item deleted. <button class="undo-btn" onclick="undoDelete()">Undo</button>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    console.log('Grocery List App Version: 2.23 (Unit label and column width update), Loaded at:', new Date().toLocaleString());
    // Check if loaded via file:// and warn user
    if (window.location.protocol === 'file:') {
      console.warn('Service Worker will not work with file:// protocol. Serve the app via http://localhost (e.g., using `python -m http.server 8000`) or host it on GitHub Pages.');
    }
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js', { scope: './' })
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.error('Service Worker registration failed:', err.message, err.stack));
      });
    }

    let items = [];
    const defaultCategories = ['General', 'Produce', 'Dairy', 'Bakery', 'Meat'];
    let categories = [];
    let suggestions = [];
    let showUnprocured = false;
    let lastDeletedItem = null;
    let pendingItem = null;
    let sortBy = 'name';
    let sortOrder = 'asc';
    try {
      const storedCategories = localStorage.getItem('groceryCategories');
      console.log('Raw groceryCategories from localStorage:', storedCategories);
      categories = storedCategories ? JSON.parse(storedCategories) : defaultCategories;
      if (!Array.isArray(categories)) {
        categories = defaultCategories;
      }
      categories = [...new Set([...categories, ...defaultCategories])];
    } catch (e) {
      console.error('Error parsing groceryCategories:', e);
      categories = defaultCategories;
    }
    try {
      const storedItems = localStorage.getItem('groceryItems');
      console.log('Raw groceryItems from localStorage:', storedItems);
      items = storedItems ? JSON.parse(storedItems) : [];
      if (!Array.isArray(items)) {
        console.error('Invalid items data, resetting to empty array');
        items = [];
      }
    } catch (e) {
      console.error('Error parsing groceryItems:', e);
      items = [];
    }
    try {
      const storedSuggestions = localStorage.getItem('grocerySuggestions');
      console.log('Raw grocerySuggestions from localStorage:', storedSuggestions);
      suggestions = storedSuggestions ? JSON.parse(storedSuggestions) : [];
      if (!Array.isArray(suggestions)) {
        suggestions = [];
      }
    } catch (e) {
      console.error('Error parsing grocerySuggestions:', e);
      suggestions = [];
    }
    let shopInfo = { name: '', description: '' };
    try {
      const storedShop = localStorage.getItem('groceryShop');
      console.log('Raw groceryShop from localStorage:', storedShop);
      shopInfo = storedShop ? JSON.parse(storedShop) : { name: '', description: '' };
    } catch (e) {
      console.error('Error parsing groceryShop:', e);
    }
    let listDate = localStorage.getItem('groceryListDate') || new Date().toDateString();
    let savedLists = {};
    try {
      const storedLists = localStorage.getItem('savedGroceryLists');
      console.log('Raw savedGroceryLists from localStorage:', storedLists);
      savedLists = storedLists ? JSON.parse(storedLists) : {};
    } catch (e) {
      console.error('Error parsing savedGroceryLists:', e);
    }

    // Validate items
    items = items.map((item, index) => ({
      name: item.name || 'Unknown',
      qty: item.qty || 1,
      units: item.units || '',
      category: item.category || 'General',
      procured: !!item.procured,
      remarks: item.remarks || ''
    }));
    console.log('Initialized items:', items);
    console.log('Initialized suggestions:', suggestions);

    function saveData() {
      try {
        localStorage.setItem('groceryItems', JSON.stringify(items));
        localStorage.setItem('groceryCategories', JSON.stringify(categories));
        localStorage.setItem('grocerySuggestions', JSON.stringify(suggestions));
        localStorage.setItem('groceryShop', JSON.stringify(shopInfo));
        localStorage.setItem('groceryListDate', listDate);
        localStorage.setItem('savedGroceryLists', JSON.stringify(savedLists));
        console.log('Data saved to localStorage');
      } catch (e) {
        console.error('Error saving to localStorage:', e);
      }
    }

    function syncColumnWidths() {
      console.log('Syncing column widths');
      const headers = document.querySelectorAll('.item-table thead th');
      const rows = document.querySelectorAll('.item-table tbody tr');
      if (headers.length && rows.length) {
        const columnWidths = Array.from(headers).map((header, index) => {
          const width = header.getBoundingClientRect().width;
          console.log(`Column ${index + 1} header width: ${width}px`);
          return width;
        });
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          cells.forEach((cell, index) => {
            cell.style.width = `${columnWidths[index]}px`;
            console.log(`Set column ${index + 1} cell width: ${columnWidths[index]}px`);
          });
        });
      } else {
        console.log('No headers or rows found for width sync');
      }
    }

    // Debounce resize event
    let resizeTimeout;
    function debounceSyncWidths() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(syncColumnWidths, 100);
    }

    function sortByColumn(column) {
      if (sortBy === column) {
        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        sortBy = column;
        sortOrder = 'asc';
      }
      console.log(`Sorting by ${sortBy}, order: ${sortOrder}`);
      updateSortIndicators();
      renderItems();
    }

    function updateSortIndicators() {
      document.getElementById('sortNameIndicator').textContent = sortBy === 'name' ? (sortOrder === 'asc' ? '↑' : '↓') : '';
      document.getElementById('sortCategoryIndicator').textContent = sortBy === 'category' ? (sortOrder === 'asc' ? '↑' : '↓') : '';
    }

    function toggleFilter() {
      showUnprocured = !showUnprocured;
      console.log('Filter toggled, showUnprocured:', showUnprocured);
      updateFilterIndicator();
      renderItems();
    }

    function updateFilterIndicator() {
      const filterIndicator = document.getElementById('filterIndicator');
      filterIndicator.innerHTML = showUnprocured ? '<i class="fas fa-filter"></i>' : '<i class="fas fa-shopping-cart"></i>';
    }

    function openModal(type, index = null) {
      const modal = document.getElementById('modal');
      const modalContent = document.getElementById('modalContent');
      const tableContainer = document.querySelector('.table-container');
      modal.style.display = 'flex';
      tableContainer.classList.add('modal-active');

      if (type === 'item') {
        modalContent.innerHTML = `
          <h2>Add Item</h2>
          <label>Name: <input type="text" id="itemName" list="itemSuggestions" oninput="updateCategorySuggestion()"></label><br>
          <datalist id="itemSuggestions">
            ${[...new Set(suggestions.map(s => s.name))].sort((a, b) => a.localeCompare(b)).map(name => `<option value="${name}">`).join('')}
          </datalist>
          <label>Quantity: <input type="number" id="itemQty" min="1" value="1"></label><br>
          <label>Unit: <input type="text" id="itemUnits"></label><br>
          <label>Category: 
            <select id="itemCategory">
              ${[...categories].sort((a, b) => a.localeCompare(b)).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            </select>
          </label><br>
          <label>Remarks: <textarea id="itemRemarks"></textarea></label><br>
          <div class="modal-actions">
            <button onclick="addItem()">Save</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
        `;
      } else if (type === 'edit') {
        const item = items[index] || { name: '', qty: 1, units: '', category: 'General', remarks: '' };
        modalContent.innerHTML = `
          <h2>Edit Item</h2>
          <label>Name: <input type="text" id="itemName" value="${item.name}" list="itemSuggestions" oninput="updateCategorySuggestion()"></label><br>
          <datalist id="itemSuggestions">
            ${[...new Set(suggestions.map(s => s.name))].sort((a, b) => a.localeCompare(b)).map(name => `<option value="${name}">`).join('')}
          </datalist>
          <label>Quantity: <input type="number" id="itemQty" min="1" value="${item.qty}"></label><br>
          <label>Unit: <input type="text" id="itemUnits" value="${item.units}"></label><br>
          <label>Category: 
            <select id="itemCategory">
              ${[...categories].sort((a, b) => a.localeCompare(b)).map(cat => `<option value="${cat}" ${cat === item.category ? 'selected' : ''}>${cat}</option>`).join('')}
            </select>
          </label><br>
          <label>Remarks: <textarea id="itemRemarks">${item.remarks}</textarea></label><br>
          <div class="modal-actions">
            <button onclick="editItem(${index})">Save</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
        `;
      } else if (type === 'category') {
        modalContent.innerHTML = `
          <h2>Add/Edit Category</h2>
          <label>New Category: <input type="text" id="newCategory"></label><br>
          <div class="modal-actions">
            <button onclick="addCategory()">Add</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
          <h3>Existing Categories</h3>
          <ul>${categories.map(cat => `<li>${cat} <button onclick="deleteCategory('${cat}')">Delete</button></li>`).join('')}</ul>
        `;
      } else if (type === 'shop') {
        modalContent.innerHTML = `
          <h2>Set Shop Info</h2>
          <label>Name: <input type="text" id="shopName" value="${shopInfo.name}"></label><br>
          <label>Description: <textarea id="shopDesc">${shopInfo.description}</textarea></label><br>
          <div class="modal-actions">
            <button onclick="saveShop()">Save</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
        `;
      } else if (type === 'save') {
        modalContent.innerHTML = `
          <h2>Save List</h2>
          <label>List Name: <input type="text" id="listName"></label><br>
          <div class="modal-actions">
            <button onclick="saveList()">Save</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
        `;
      } else if (type === 'load') {
        modalContent.innerHTML = `
          <h2>Load List</h2>
          <h3>Saved Lists</h3>
          <select id="listSelect">
            ${Object.keys(savedLists).map(name => `<option value="${name}">${name}</option>`).join('') || '<option>No saved lists</option>'}
          </select><br>
          <div class="modal-actions">
            <button onclick="loadList()">Load</button>
            <button onclick="deleteList()">Delete</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
          <h3>Load Shared List</h3>
          <textarea id="sharedListText" placeholder="Paste shared list text here"></textarea><br>
          <div class="modal-actions">
            <button onclick="loadSharedList()">Load Shared List</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
        `;
      } else if (type === 'share') {
        const shareText = generateShareText();
        modalContent.innerHTML = `
          <h2>Share List</h2>
          <p>Copy the text below to share:</p>
          <textarea id="shareText" readonly>${shareText}</textarea><br>
          <div class="modal-actions">
            <button onclick="copyToClipboard()">Copy to Clipboard</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
        `;
      } else if (type === 'row') {
        const item = items[index] || { name: '', qty: 1, units: '', category: 'General', remarks: '' };
        modalContent.innerHTML = `
          <h2>Manage Item</h2>
          <p>Item: ${item.name}</p>
          <p>Quantity: ${item.qty}</p>
          <p>Unit: ${item.units || 'None'}</p>
          <p>Category: ${item.category}</p>
          <p>Remarks: ${item.remarks || 'None'}</p>
          <div class="modal-actions">
            <button class="edit-btn" onclick="openModal('edit', ${index})">Edit</button>
            <button class="delete-btn" onclick="deleteItem(${index})">Delete</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
        `;
      } else if (type === 'reassign') {
        const cat = index; // index is category name for reassign modal
        modalContent.innerHTML = `
          <h2>Delete Category: ${cat}</h2>
          <p>Items in '${cat}' will be reassigned to:</p>
          <select id="reassignCategory">
            ${categories.filter(c => c !== cat).map(c => `<option value="${c}">${c}</option>`).join('')}
          </select><br>
          <div class="modal-actions">
            <button onclick="reassignAndDeleteCategory('${cat}')">Reassign and Delete</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
        `;
      } else if (type === 'duplicate') {
        const item = items[index];
        modalContent.innerHTML = `
          <h2>Duplicate Item Detected</h2>
          <p>An item with name "${pendingItem.name}" and category "${pendingItem.category}" already exists:</p>
          <p>Existing: ${item.name}, Qty: ${item.qty}, Unit: ${item.units || 'None'}, Category: ${item.category}, Remarks: ${item.remarks || 'None'}</p>
          <p>New: ${pendingItem.name}, Qty: ${pendingItem.qty}, Unit: ${pendingItem.units || 'None'}, Category: ${pendingItem.category}, Remarks: ${pendingItem.remarks || 'None'}</p>
          <p>Would you like to update the existing item's quantity?</p>
          <div class="modal-actions">
            <button class="update-btn" onclick="updateItemQuantity(${index}, ${pendingItem.qty})">Update Quantity</button>
            <button class="edit-btn" onclick="addNewItemAnyway()">Add New</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
          </div>
        `;
      }
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      document.querySelector('.table-container').classList.remove('modal-active');
      pendingItem = null; // Clear pending item on modal close
    }

    function addItem() {
      const name = document.getElementById('itemName').value.trim();
      const qty = parseInt(document.getElementById('itemQty').value);
      const units = document.getElementById('itemUnits').value.trim();
      const category = document.getElementById('itemCategory').value;
      const remarks = document.getElementById('itemRemarks').value.trim();

      if (!name || qty <= 0) {
        alert('Please enter valid item name and quantity.');
        return;
      }

      // Check for duplicate item
      const duplicateIndex = items.findIndex(
        item => item.name.toLowerCase() === name.toLowerCase() && item.category === category
      );
      if (duplicateIndex !== -1) {
        pendingItem = { name, qty, units, category, procured: false, remarks };
        console.log('Duplicate item detected:', pendingItem, 'Existing item at index:', duplicateIndex);
        openModal('duplicate', duplicateIndex);
        return;
      }

      items.push({ name, qty, units, category, procured: false, remarks });
      if (!categories.includes(category)) {
        categories.push(category);
      }
      suggestions.push({ name, category, units, remarks });
      saveData();
      renderItems();
      closeModal();
    }

    function updateItemQuantity(index, newQty) {
      if (index >= 0 && index < items.length && newQty > 0) {
        items[index].qty += newQty;
        console.log(`Updated quantity for item at index ${index}:`, items[index]);
        suggestions.push({ 
          name: items[index].name, 
          category: items[index].category, 
          units: items[index].units, 
          remarks: items[index].remarks 
        });
        saveData();
        renderItems();
        closeModal();
      } else {
        console.error('Invalid index or quantity for updateItemQuantity:', index, newQty);
        alert('Error updating item quantity.');
      }
    }

    function addNewItemAnyway() {
      if (pendingItem) {
        items.push({ ...pendingItem });
        if (!categories.includes(pendingItem.category)) {
          categories.push(pendingItem.category);
        }
        suggestions.push({ 
          name: pendingItem.name, 
          category: pendingItem.category, 
          units: pendingItem.units, 
          remarks: pendingItem.remarks 
        });
        console.log('Added new item despite duplicate:', pendingItem);
        saveData();
        renderItems();
        closeModal();
      } else {
        console.error('No pending item to add');
        alert('Error adding new item.');
      }
    }

    function editItem(index) {
      const name = document.getElementById('itemName').value.trim();
      const qty = parseInt(document.getElementById('itemQty').value);
      const units = document.getElementById('itemUnits').value.trim();
      const category = document.getElementById('itemCategory').value;
      const remarks = document.getElementById('itemRemarks').value.trim();

      if (name && qty > 0 && index >= 0 && index < items.length) {
        items[index] = { ...items[index], name, qty, units, category, remarks };
        if (!categories.includes(category)) {
          categories.push(category);
        }
        suggestions.push({ name, category, units, remarks });
        saveData();
        renderItems();
        closeModal();
      } else {
        alert('Please enter valid item details or select a valid item.');
      }
    }

    function deleteItem(index) {
      console.log('deleteItem called with index:', index, 'Item:', items[index], 'Items before:', items);
      if (index < 0 || index >= items.length || isNaN(index)) {
        console.error('Invalid index:', index);
        alert('Error: Cannot delete item. Invalid index.');
        return;
      }
      const itemName = items[index].name.replace(/'/g, "\\'");
      if (confirm(`Are you sure you want to delete '${itemName}'?`)) {
        lastDeletedItem = { item: { ...items[index] }, index };
        console.log('Stored lastDeletedItem:', lastDeletedItem);
        items.splice(index, 1);
        console.log('Items after deletion:', items);
        showUndoNotification();
        saveData();
        renderItems();
        closeModal();
      }
    }

    function undoDelete() {
      if (lastDeletedItem) {
        console.log('Undoing deletion, restoring:', lastDeletedItem);
        items.splice(lastDeletedItem.index, 0, lastDeletedItem.item);
        lastDeletedItem = null;
        hideUndoNotification();
        saveData();
        renderItems();
      }
    }

    function showUndoNotification() {
      const notification = document.getElementById('undoNotification');
      notification.style.display = 'block';
      setTimeout(() => {
        if (lastDeletedItem) {
          hideUndoNotification();
        }
      }, 5000);
    }

    function hideUndoNotification() {
      const notification = document.getElementById('undoNotification');
      notification.style.display = 'none';
      lastDeletedItem = null;
      console.log('Undo notification hidden, lastDeletedItem cleared');
    }

    function updateCategorySuggestion() {
      const nameInput = document.getElementById('itemName').value.trim();
      const categorySelect = document.getElementById('itemCategory');
      const unitsInput = document.getElementById('itemUnits');
      if (nameInput) {
        const matchingSuggestions = suggestions.filter(s => s.name.toLowerCase() === nameInput.toLowerCase());
        if (matchingSuggestions.length > 0) {
          const latestSuggestion = matchingSuggestions[matchingSuggestions.length - 1];
          categorySelect.value = latestSuggestion.category;
          unitsInput.value = latestSuggestion.units || '';
          console.log('Suggested category for', nameInput, ':', latestSuggestion.category, 'Unit:', latestSuggestion.units);
        } else {
          categorySelect.value = 'General';
          unitsInput.value = '';
        }
      } else {
        categorySelect.value = 'General';
        unitsInput.value = '';
      }
    }

    function addCategory() {
      const newCat = document.getElementById('newCategory').value.trim();
      if (newCat && !categories.includes(newCat)) {
        categories.push(newCat);
        saveData();
        openModal('category');
      } else {
        alert('Enter a unique category name.');
      }
    }

    function deleteCategory(cat) {
      if (categories.length <= 1) {
        alert('Cannot delete the last category.');
        return;
      }
      const itemsWithCategory = items.filter(item => item.category === cat);
      if (itemsWithCategory.length > 0) {
        openModal('reassign', cat);
      } else {
        categories = categories.filter(c => c !== cat);
        saveData();
        openModal('category');
      }
    }

    function reassignAndDeleteCategory(cat) {
      const newCat = document.getElementById('reassignCategory').value;
      if (!newCat) {
        alert('Please select a category to reassign items to.');
        return;
      }
      items = items.map(item => item.category === cat ? { ...item, category: newCat } : item);
      categories = categories.filter(c => c !== cat);
      console.log(`Reassigned items from ${cat} to ${newCat}, deleted category ${cat}`);
      saveData();
      renderItems();
      closeModal();
    }

    function clearAllProcured() {
      if (confirm('Clear procured status for all items?')) {
        items.forEach(item => item.procured = false);
        console.log('Cleared procured status for all items:', items);
        saveData();
        renderItems();
      }
    }

    function saveShop() {
      shopInfo.name = document.getElementById('shopName').value.trim();
      shopInfo.description = document.getElementById('shopDesc').value.trim();
      saveData();
      renderItems();
      closeModal();
    }

    function saveList() {
      const listName = document.getElementById('listName').value.trim();
      if (listName) {
        // Update suggestions with current items
        items.forEach(item => {
          suggestions = suggestions.filter(s => s.name.toLowerCase() !== item.name.toLowerCase());
          suggestions.push({ 
            name: item.name, 
            category: item.category, 
            units: item.units, 
            remarks: item.remarks 
          });
        });
        console.log('Updated suggestions on saveList:', suggestions);
        savedLists[listName] = { items, shopInfo, listDate };
        saveData();
        closeModal();
      } else {
        alert('Please enter a valid list name.');
      }
    }

    function loadList() {
      const listName = document.getElementById('listSelect').value;
      if (listName && savedLists[listName]) {
        items = savedLists[listName].items;
        shopInfo = savedLists[listName].shopInfo;
        listDate = savedLists[listName].listDate;
        // Update suggestions with loaded items
        items.forEach(item => {
          suggestions = suggestions.filter(s => s.name.toLowerCase() !== item.name.toLowerCase());
          suggestions.push({ 
            name: item.name, 
            category: item.category, 
            units: item.units, 
            remarks: item.remarks 
          });
        });
        console.log('Updated suggestions on loadList:', suggestions);
        saveData();
        renderItems();
        closeModal();
      } else {
        alert('Please select a valid list.');
      }
    }

    function deleteList() {
      const listName = document.getElementById('listSelect').value;
      if (listName && savedLists[listName]) {
        delete savedLists[listName];
        saveData();
        openModal('load');
      } else {
        alert('Please select a valid list to delete.');
      }
    }

    function createNewList() {
      if (confirm('Create a new list? This will clear the current list.')) {
        items = [];
        shopInfo = { name: '', description: '' };
        listDate = new Date().toDateString();
        saveData();
        renderItems();
      }
    }

    function generateShareText() {
      let text = `Grocery List\nShop: ${shopInfo.name || 'Not set'}\nDate: ${listDate}\nDescription: ${shopInfo.description || 'None'}\n\nItems:\n`;
      items.forEach(item => {
        text += `- ${item.name} (Qty: ${item.qty}, Unit: ${item.units || 'None'}, Category: ${item.category}, ${item.procured ? 'Procured' : 'Not Procured'}, Remarks: ${item.remarks || 'None'})\n`;
      });
      return text;
    }

    function copyToClipboard() {
      const shareText = document.getElementById('shareText');
      shareText.select();
      document.execCommand('copy');
      alert('List copied to clipboard!');
      closeModal();
    }

    function loadSharedList() {
      const sharedText = document.getElementById('sharedListText').value.trim();
      if (!sharedText) {
        alert('Please paste a valid shared list text.');
        return;
      }

      try {
        const lines = sharedText.split('\n').map(line => line.trim());
        if (lines[0] !== 'Grocery List') {
          throw new Error('Invalid list format.');
        }

        let newItems = [];
        let newShopInfo = { name: '', description: '' };
        let newListDate = new Date().toDateString();
        let parsingItems = false;

        for (let line of lines) {
          if (line.startsWith('Shop: ')) {
            newShopInfo.name = line.replace('Shop: ', '');
          } else if (line.startsWith('Date: ')) {
            newListDate = line.replace('Date: ', '');
          } else if (line.startsWith('Description: ')) {
            newShopInfo.description = line.replace('Description: ', '');
          } else if (line === 'Items:') {
            parsingItems = true;
          } else if (parsingItems && line.startsWith('- ')) {
            const match = line.match(/- (.+?) \(Qty: (\d+), Unit: (.+?), Category: (.+?), (Procured|Not Procured), Remarks: (.+?)\)/);
            if (match) {
              const [, name, qty, units, category, procured, remarks] = match;
              newItems.push({
                name,
                qty: parseInt(qty),
                units: units === 'None' ? '' : units,
                category,
                procured: procured === 'Procured',
                remarks: remarks === 'None' ? '' : remarks
              });
              if (!categories.includes(category)) {
                categories.push(category);
              }
              suggestions.push({ name, category, units, remarks });
            }
          }
        }

        items = newItems;
        shopInfo = newShopInfo;
        listDate = newListDate;
        saveData();
        renderItems();
        closeModal();
      } catch (error) {
        alert('Error loading shared list: Invalid format.');
      }
    }

    function openRowModal(index) {
      console.log('openRowModal called with index:', index);
      if (index >= 0 && index < items.length) {
        openModal('row', index);
      } else {
        console.error('Invalid index for openRowModal:', index);
      }
    }

    function renderItems() {
      console.log('Starting renderItems, items:', items);
      const itemList = document.getElementById('itemList');
      let filteredItems = showUnprocured ? items.filter(item => !item.procured && item.name && item.qty && item.category) : [...items].filter(item => item.name && item.qty && item.category);

      console.log('Filtered items before sort:', filteredItems, 'Sort by:', sortBy, 'Order:', sortOrder);

      filteredItems.sort((a, b) => {
        const valueA = (sortBy === 'name' ? a.name : a.category) || '';
        const valueB = (sortBy === 'name' ? b.name : b.category) || '';
        const comparison = valueA.localeCompare(valueB);
        return sortOrder === 'asc' ? comparison : -comparison;
      });

      console.log('Filtered items after sort:', filteredItems);

      let html = '';
      filteredItems.forEach((item, displayIndex) => {
        if (!item.name || !item.qty || !item.category) {
          console.error('Invalid item at displayIndex:', displayIndex, 'Item:', item);
          return;
        }
        const originalIndex = items.findIndex(i => 
          i.name === item.name && 
          i.qty === item.qty && 
          i.units === item.units && 
          i.category === item.category && 
          i.procured === item.procured && 
          i.remarks === item.remarks
        );
        if (originalIndex === -1) {
          console.error('Could not find original index for item:', item, 'displayIndex:', displayIndex);
          return;
        }
        console.log('Rendering item:', item, 'Display index:', displayIndex, 'Original index:', originalIndex);
        html += `
          <tr data-index="${originalIndex}" ondblclick="openRowModal(${originalIndex})">
            <td>${item.name}</td>
            <td>${item.qty}</td>
            <td>${item.units || ''}</td>
            <td>${item.category}</td>
            <td><input type="checkbox" ${item.procured ? 'checked' : ''} onchange="toggleProcured(${originalIndex}, event)"></td>
            <td>${item.remarks || ''}</td>
          </tr>
        `;
      });
      itemList.innerHTML = html;
      console.log('Rendered HTML:', html);

      const total = items.length;
      const procured = items.filter(item => item.procured).length;
      const percent = total ? Math.round((procured / total) * 100) : 0;
      document.getElementById('progress').textContent = `${procured} of ${total} items procured - ${percent}%`;

      document.getElementById('listDate').textContent = `Shop: ${shopInfo.name || 'Not set'} | Date: ${listDate}`;

      // Sync column widths after rendering
      syncColumnWidths();
    }

    function toggleProcured(index, event) {
      console.log('toggleProcured called with index:', index);
      if (index >= 0 && index < items.length) {
        items[index].procured = !items[index].procured;
        saveData();
        renderItems();
        event.stopPropagation(); // Prevent double-click modal from opening
      } else {
        console.error('Invalid index for toggleProcured:', index);
      }
    }

    // Initialize
    updateSortIndicators();
    updateFilterIndicator();
    renderItems();
    window.addEventListener('resize', debounceSyncWidths);
  </script>
</body>
</html>